#include <iostream>
#include <vector>
#include <fstream>
#include <iomanip>
#include <sstream>
using namespace std;

// =========================
// CLASS: Expense
// =========================

class Expense {
private:
    string date;
    string category;
    double amount;
    string description;

public:
    Expense(string d="", string c="", double a=0.0, string desc="") {
        date = d;
        category = c;
        amount = a;
        description = desc;
    }

    void displayExpense() {
        cout << setw(12) << date 
             << setw(12) << category 
             << setw(10) << amount 
             << "    " << description << endl;
    }

    string getCategory() { return category; }
    string getDate() { return date; }
    double getAmount() { return amount; }
    // For saving to file
        string toString() {
            std::ostringstream oss;
            oss << amount;
            return date + "|" + category + "|" + oss.str() + "|" + description;
        }
    };

// =========================
// CLASS: ExpenseManager
// =========================

class ExpenseManager {
private:
    vector<Expense> expenses;

public:
    void addExpense(Expense e) {
        expenses.push_back(e);
    }

    void viewAllExpenses() {
        if(expenses.empty()) {
            cout << "\nNo expenses found.\n";
            return;
        }

        cout << "\nDate         Category     Amount      Description\n";
        cout << "------------------------------------------------------\n";

        for(auto &e : expenses)
            e.displayExpense();
    }

    void viewByCategory(string cat) {
        cout << "\nExpenses in category: " << cat << "\n";
        cout << "------------------------------------------------------\n";

        for(auto &e : expenses) {
            if(e.getCategory() == cat)
                e.displayExpense();
        }
    }

    double getTotal() {
        double sum = 0;
        for(auto &e : expenses)
            sum += e.getAmount();
        return sum;
    }

    vector<Expense>& getExpenses() {
        return expenses;
    }

    // Save to a text file
    void saveToFile() {
        ofstream f("expenses.txt");
        for(auto &e : expenses)
            f << e.toString() << endl;
        f.close();
    }

    // Load from text file
    void loadFromFile() {
        ifstream f("expenses.txt");
        if (!f) return;

        expenses.clear();
        string line;

        while(getline(f, line)) {
            string d, c, desc;
            double amt;

            int p1 = line.find("|");
            int p2 = line.find("|", p1+1);
            int p3 = line.find("|", p2+1);

            d = line.substr(0, p1);
            c = line.substr(p1+1, p2-p1-1);
            amt = stod(line.substr(p2+1, p3-p2-1));
            desc = line.substr(p3+1);

            expenses.push_back(Expense(d, c, amt, desc));
        }
        f.close();
    }
};

// =========================
// POLYMORPHISM FOR REPORTS
// =========================

class ReportManager {
public:
    virtual void generateReport(ExpenseManager &em) = 0;
};

class SimpleReport : public ReportManager {
public:
    void generateReport(ExpenseManager &em) override {
        cout << "\n===== SIMPLE REPORT =====\n";
        cout << "Total Spent: " << em.getTotal() << "\n";
        cout << "==========================\n";
    }
};

class CategoryReport : public ReportManager {
public:
    void generateReport(ExpenseManager &em) override {
        cout << "\n===== CATEGORY REPORT =====\n";
        vector<Expense> &list = em.getExpenses();
        double food=0, travel=0, shop=0, other=0;

        for(auto &e : list) {
            if(e.getCategory() == "Food") food += e.getAmount();
            else if(e.getCategory() == "Travel") travel += e.getAmount();
            else if(e.getCategory() == "Shopping") shop += e.getAmount();
            else other += e.getAmount();
        }

        cout << "Food: " << food << endl;
        cout << "Travel: " << travel << endl;
        cout << "Shopping: " << shop << endl;
        cout << "Other: " << other << endl;
        cout << "===========================\n";
    }
};

// =========================
// CLASS: User
// =========================

class User {
private:
    string username;
    double budgetLimit;

public:
    User(string name="", double limit=0.0) {
        username = name;
        budgetLimit = limit;
    }

    void checkBudget(double total) {
        if(total > budgetLimit)
            cout << "\n⚠️ WARNING: You have exceeded your budget!\n";
        else if(total > 0.8 * budgetLimit)
            cout << "\n⚠️ ALERT: You are close to exceeding your budget.\n";
    }
};

// =========================
// MAIN PROGRAM
// =========================

int main() {
    ExpenseManager manager;
    manager.loadFromFile();

    User user("Tanishq", 5000); // budget example

    int choice;
    while(true) {
        cout << "\n===== SMART EXPENSE TRACKER =====\n";
        cout << "1. Add Expense\n";
        cout << "2. View All Expenses\n";
        cout << "3. View By Category\n";
        cout << "4. Simple Report\n";
        cout << "5. Category Report\n";
        cout << "6. Save & Exit\n";
        cout << "Choose: ";
        cin >> choice;

        if(choice == 1) {
            string date, cat, desc;
            double amt;

            cout << "Enter date (DD-MM-YYYY): ";
            cin >> date;
            cout << "Enter category (Food/Travel/Shopping/Other): ";
            cin >> cat;
            cout << "Enter amount: ";
            cin >> amt;
            cin.ignore();
            cout << "Enter description: ";
            getline(cin, desc);

            manager.addExpense(Expense(date, cat, amt, desc));
            cout << "Expense added!\n";
            user.checkBudget(manager.getTotal());
        }

        else if(choice == 2) {
            manager.viewAllExpenses();
        }

        else if(choice == 3) {
            string cat;
            cout << "Enter category: ";
            cin >> cat;
            manager.viewByCategory(cat);
        }

        else if(choice == 4) {
            SimpleReport sr;
            sr.generateReport(manager);
        }

        else if(choice == 5) {
            CategoryReport cr;
            cr.generateReport(manager);
        }

        else if(choice == 6) {
            manager.saveToFile();
            cout << "Data saved. Exiting...\n";
            break;
        }

        else {
            cout << "Invalid choice.\n";
        }
    }

    return 0;
}


